import{d as j,r as n,av as B,aw as R,o as v,c as D,q as f,w as c,u as t,f as s,x as _,a3 as w,y as H,D as K,L as V,F as G,z as J,H as Q,I as X,i as Y,K as Z,M as $}from"./index-DPENBzsb.js";import{_ as ee}from"./DictTag.vue_vue_type_script_lang-pTU0zhE7.js";import{d as ae}from"./formatTime-C7TQtsxQ.js";import{g as le,P as y,d as ie,a as se}from"./index-Cb-L5Bqt.js";import{_ as te}from"./PermissionForm.vue_vue_type_script_setup_true_lang-DymHMb9s.js";const re=j({name:"CrmPermissionList",__name:"PermissionList",props:{bizType:{},bizId:{},showAction:{type:Boolean}},emits:["quitTeam"],setup(x,{expose:C,emit:U}){const o=J(),u=x,h=n(!0),r=n([]),N=n({ownerUserId:0}),g=B(),k=async()=>{h.value=!0;try{const a=await le({bizType:u.bizType,bizId:u.bizId});r.value=a,r.value.find(e=>e.userId===g.getUser.id&&e.level===y.OWNER)&&(N.value.ownerUserId=g.getUser.id)}finally{h.value=!1}},d=n([]),T=n(),O=a=>{var e;if(a.findIndex(l=>l.level===y.OWNER)!==-1)return o.warning("\u4E0D\u80FD\u9009\u62E9\u8D1F\u8D23\u4EBA\uFF01"),void((e=T.value)==null?void 0:e.clearSelection());d.value=a},z=n(),W=()=>{var a,e,l;((a=d.value)==null?void 0:a.length)!==0?((e=d.value)==null?void 0:e.length)>1?o.warning("\u7F16\u8F91\u56E2\u961F\u6210\u5458\u65F6\u53EA\u80FD\u9009\u62E9\u4E00\u4E2A\uFF01"):(l=z.value)==null||l.open0("update",u.bizType,u.bizId,d.value[0].id,d.value[0].level):o.warning("\u8BF7\u5148\u9009\u62E9\u56E2\u961F\u6210\u5458\u540E\u64CD\u4F5C\uFF01")},L=async()=>{var e,l;if(((e=d.value)==null?void 0:e.length)===0)return void o.warning("\u8BF7\u5148\u9009\u62E9\u56E2\u961F\u6210\u5458\u540E\u64CD\u4F5C\uFF01");await o.delConfirm();const a=(l=d.value)==null?void 0:l.map(i=>i.id);await ie(a),o.success("\u79FB\u9664\u56E2\u961F\u6210\u5458\u6210\u529F\uFF01"),await k()},E=()=>{var a;(a=z.value)==null||a.open("create",u.bizType,u.bizId)},p=n(!1),b=n(!1),I=n(!1);R(r,a=>{var e;if(I.value=!1,(a==null?void 0:a.length)>0){I.value=!r.value.some(i=>i.level===y.OWNER),p.value=!1,b.value=!1;const l=(e=g.getUser)==null?void 0:e.id;r.value.filter(i=>i.userId===l).forEach(i=>{i.level===y.OWNER?(p.value=!0,b.value=!0):i.level===y.WRITE&&(b.value=!0)})}else I.value=!0},{immediate:!0}),C({openForm:E,validateOwnerUser:p,validateWrite:b,isPool:I});const P=U,S=async()=>{if(r.value.find(e=>e.userId===g.getUser.id&&e.level===y.OWNER))return void o.warning("\u8D1F\u8D23\u4EBA\u4E0D\u80FD\u9000\u51FA\u56E2\u961F\uFF01");const a=r.value.find(e=>e.userId===g.getUser.id);a&&(await se(a.id),o.success("\u9000\u51FA\u56E2\u961F\u6210\u5458\u6210\u529F\uFF01"),P("quitTeam"))};return R(()=>u.bizId,a=>{a&&k()},{immediate:!0,deep:!0}),(a,e)=>{const l=Q,i=X,q=Y,m=Z,M=ee,A=$;return v(),D(G,null,[a.showAction?(v(),f(q,{key:0,justify:"end"},{default:c(()=>[t(p)?(v(),f(i,{key:0,type:"primary",onClick:E},{default:c(()=>[s(l,{class:"mr-5px",icon:"ep:plus"}),e[0]||(e[0]=_(" \u65B0\u589E "))]),_:1})):w("",!0),t(p)?(v(),f(i,{key:1,onClick:W},{default:c(()=>[s(l,{class:"mr-5px",icon:"ep:edit"}),e[1]||(e[1]=_(" \u7F16\u8F91 "))]),_:1})):w("",!0),t(p)?(v(),f(i,{key:2,onClick:L},{default:c(()=>[s(l,{class:"mr-5px",icon:"ep:delete"}),e[2]||(e[2]=_(" \u79FB\u9664 "))]),_:1})):w("",!0),!t(p)&&t(r).length>0?(v(),f(i,{key:3,type:"danger",onClick:S},{default:c(()=>e[3]||(e[3]=[_(" \u9000\u51FA\u56E2\u961F ")])),_:1})):w("",!0)]),_:1})):w("",!0),H((v(),f(t(V),{ref_key:"elTableRef",ref:T,data:t(r),"show-overflow-tooltip":!0,stripe:!0,class:"mt-20px",onSelectionChange:O},{default:c(()=>[s(m,{type:"selection",width:"55"}),s(m,{align:"center",label:"\u59D3\u540D",prop:"nickname"}),s(m,{align:"center",label:"\u90E8\u95E8",prop:"deptName"}),s(m,{align:"center",label:"\u5C97\u4F4D",prop:"postNames"}),s(m,{align:"center",label:"\u6743\u9650\u7EA7\u522B",prop:"level"},{default:c(({row:F})=>[s(M,{type:t(K).CRM_PERMISSION_LEVEL,value:F.level},null,8,["type","value"])]),_:1}),s(m,{formatter:t(ae),align:"center",label:"\u52A0\u5165\u65F6\u95F4",prop:"createTime"},null,8,["formatter"])]),_:1},8,["data"])),[[A,t(h)]]),s(te,{ref_key:"formRef",ref:z,onSuccess:k},null,512)],64)}}});export{re as _};
